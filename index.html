<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å¤šè¯­è¨€ç¿»è¯‘å™¨V2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
            background: #f5f5f7;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            color: #1d1d1f;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            max-width: 1300px;
            width: 100%;
            padding: 50px;
            animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            margin: 20px 0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            text-align: center;
            color: #1d1d1f;
            margin-bottom: 40px;
            font-size: 2.8em;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .translator-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 30px;
        }

        .input-panel, .output-panel {
            background: #f9f9f9;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid #e5e5e5;
            transition: all 0.2s ease;
        }

        .input-panel:hover, .output-panel:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .panel-title {
            font-size: 0.95em;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .language-select {
            padding: 8px 16px;
            border: 1px solid rgba(0, 122, 255, 0.2);
            border-radius: 10px;
            font-size: 0.95em;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.9);
            color: #007aff;
            transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
            font-weight: 500;
            -webkit-appearance: none;
            appearance: none;
        }

        .language-select:hover {
            background: rgba(0, 122, 255, 0.08);
            border-color: #007aff;
        }

        .language-select:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        textarea {
            width: 100%;
            min-height: 220px;
            padding: 16px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 14px;
            font-size: 1.15em;
            resize: vertical;
            transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
            background: rgba(255, 255, 255, 0.6);
            color: #1d1d1f;
            line-height: 1.6;
        }

        textarea:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
            background: rgba(255, 255, 255, 0.9);
        }

        textarea::placeholder {
            color: #86868b;
        }

        .controls {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 12px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-danger {
            background: #007aff;
            color: white;
        }

        .btn-danger:hover {
            background: #0051d5;
        }

        .btn-danger:active {
            background: #004fc7;
            transform: scale(0.98);
        }

        .btn-success {
            background: #34c759;
            color: white;
        }

        .btn-success:hover {
            background: #30b350;
        }

        .btn-success:active {
            background: #2aa047;
            transform: scale(0.98);
        }

        .btn-secondary {
            background: rgba(120, 120, 128, 0.16);
            color: #1d1d1f;
        }

        .btn-secondary:hover {
            background: rgba(120, 120, 128, 0.24);
        }

        .btn-secondary:active {
            background: rgba(120, 120, 128, 0.32);
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .recording {
            background: #ff3b30 !important;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.4);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(255, 59, 48, 0);
            }
        }

        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 32px;
            flex-wrap: wrap;
            background: #f0f0f0;
            padding: 6px;
            border-radius: 12px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .mode-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: #1d1d1f;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
        }

        .mode-btn.active {
            background: white;
            color: #007aff;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }

        .mode-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.5);
        }

        .mode-btn:active {
            transform: scale(0.98);
        }

        .status-bar {
            text-align: center;
            padding: 12px 20px;
            background: #f0f7ff;
            border-radius: 12px;
            margin-bottom: 24px;
            font-size: 0.95em;
            color: #007aff;
            font-weight: 500;
        }

        .status-bar.recording {
            background: #fff0f0;
            color: #ff3b30;
        }

        .status-bar.translating {
            background: #f8f0ff;
            color: #af52de;
        }

        .char-count {
            text-align: right;
            color: #86868b;
            font-size: 0.85em;
            margin-top: 8px;
            font-weight: 500;
        }

        .feature-hint {
            background: #f0f7ff;
            border-left: 3px solid #007aff;
            padding: 16px 20px;
            margin-bottom: 24px;
            border-radius: 12px;
            color: #1d1d1f;
            font-size: 0.95em;
            line-height: 1.5;
        }

        @media (max-width: 968px) {
            .translator-section {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8em;
                margin-bottom: 20px;
            }

            .container {
                padding: 20px 16px;
                border-radius: 12px;
            }

            .mode-selector {
                width: 100%;
                padding: 4px;
                gap: 8px;
            }

            .mode-btn {
                padding: 8px 12px;
                font-size: 0.85em;
                flex: 1;
            }

            .input-panel, .output-panel {
                padding: 16px;
            }

            textarea {
                min-height: 150px;
                font-size: 1em;
            }

            .controls {
                gap: 8px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 0.9em;
                flex: 1;
            }

            .quick-phrases {
                gap: 6px;
            }

            .phrase-btn {
                padding: 6px 12px;
                font-size: 0.85em;
            }

            .history-panel {
                max-height: 250px;
                padding: 16px;
            }

            .feature-hint {
                padding: 12px 16px;
                font-size: 0.9em;
            }

            .status-bar {
                padding: 10px 16px;
                font-size: 0.9em;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            h1 {
                font-size: 1.5em;
                margin-bottom: 16px;
            }

            .container {
                padding: 16px 12px;
            }

            .mode-btn {
                padding: 8px 10px;
                font-size: 0.8em;
            }

            textarea {
                min-height: 120px;
                font-size: 0.95em;
                padding: 12px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 0.85em;
            }

            .language-select {
                padding: 6px 12px;
                font-size: 0.85em;
            }

            .panel-title {
                font-size: 0.85em;
            }
        }

        .quick-phrases {
            margin-top: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .phrase-btn {
            padding: 8px 16px;
            background: #f0f7ff;
            border: 1px solid #d0e5ff;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
            color: #007aff;
            font-weight: 500;
        }

        .phrase-btn:hover {
            background: #007aff;
            color: white;
            border-color: #007aff;
        }

        .phrase-btn:active {
            transform: scale(0.96);
        }

        .history-panel {
            background: #f9f9f9;
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
            max-height: 320px;
            overflow-y: auto;
            border: 1px solid #e5e5e5;
        }

        .history-panel::-webkit-scrollbar {
            width: 8px;
        }

        .history-panel::-webkit-scrollbar-track {
            background: transparent;
        }

        .history-panel::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.15);
            border-radius: 4px;
        }

        .history-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.25);
        }

        .history-item {
            background: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #e5e5e5;
        }

        .history-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-color: #007aff;
        }

        .history-item:active {
            transform: scale(0.99);
        }

        .history-text {
            font-size: 0.95em;
            color: #1d1d1f;
            font-weight: 500;
        }

        .history-translation {
            font-size: 0.9em;
            color: #86868b;
            margin-top: 6px;
        }

        .translating-indicator {
            display: none;
            text-align: center;
            color: #007aff;
            font-size: 0.9em;
            margin-top: 12px;
            font-weight: 500;
        }

        .translating-indicator.active {
            display: block;
        }

        .voice-controls {
            background: #f0f7ff;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid #d0e5ff;
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-track {
            background: rgba(120, 120, 128, 0.2);
            height: 4px;
            border-radius: 2px;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            -webkit-appearance: none;
            background: #007aff;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 122, 255, 0.3);
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(0, 122, 255, 0.5);
        }

        input[type="range"]::-webkit-slider-thumb:active {
            transform: scale(0.95);
        }

        input[type="range"]::-moz-range-track {
            background: rgba(120, 120, 128, 0.2);
            height: 4px;
            border-radius: 2px;
        }

        input[type="range"]::-moz-range-thumb {
            background: #007aff;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 122, 255, 0.3);
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ æ™ºèƒ½å¤šè¯­è¨€ç¿»è¯‘å™¨</h1>
        
        <div class="feature-hint">
            <strong>ğŸ’¡ æ™ºèƒ½æç¤ºï¼š</strong> æ— éœ€ç‚¹å‡»ç¿»è¯‘æŒ‰é’®ï¼Œè¾“å…¥æ–‡å­—åä¼šè‡ªåŠ¨ç¿»è¯‘ã€‚æ”¯æŒå¤šè¯­è¨€å®æ—¶äº’è¯‘ã€‚
        </div>

        <div class="status-bar" id="statusBar">
            å‡†å¤‡å°±ç»ª
        </div>

        <div class="mode-selector">
            <button class="mode-btn active" data-mode="auto">ğŸ”„ è‡ªåŠ¨æ£€æµ‹</button>
            <button class="mode-btn" data-mode="chinese-to-english">ğŸ‡¨ğŸ‡³â†’ğŸ‡¬ğŸ‡§ ä¸­è‹±å£è¯­åŒ–</button>
        </div>

        <div class="translator-section">
            <div class="input-panel">
                <div class="panel-header">
                    <span class="panel-title">æºè¯­è¨€</span>
                    <select class="language-select" id="sourceLang">
                        <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
                        <option value="zh-CN">ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰</option>
                        <option value="zh-TW">ä¸­æ–‡ï¼ˆç¹ä½“ï¼‰</option>
                        <option value="en-US">è‹±è¯­</option>
                        <option value="ja-JP">æ—¥è¯­</option>
                        <option value="ko-KR">éŸ©è¯­</option>
                        <option value="fr-FR">æ³•è¯­</option>
                        <option value="de-DE">å¾·è¯­</option>
                        <option value="es-ES">è¥¿ç­ç‰™è¯­</option>
                        <option value="ru-RU">ä¿„è¯­</option>
                        <option value="ar-SA">é˜¿æ‹‰ä¼¯è¯­</option>
                        <option value="pt-PT">è‘¡è„ç‰™è¯­</option>
                        <option value="it-IT">æ„å¤§åˆ©è¯­</option>
                        <option value="th-TH">æ³°è¯­</option>
                        <option value="vi-VN">è¶Šå—è¯­</option>
                    </select>
                </div>
                <textarea id="inputText" placeholder="å¼€å§‹è¾“å…¥æ–‡å­—ï¼Œå°†è‡ªåŠ¨ç¿»è¯‘..."></textarea>
                <div class="char-count" id="charCount">0 / 5000 å­—ç¬¦</div>
                <div class="translating-indicator" id="translatingIndicator">â³ æ­£åœ¨ç¿»è¯‘...</div>
                <div class="controls">
                    <button class="btn btn-secondary" id="clearBtn">
                        <span>âœ• æ¸…ç©º</span>
                    </button>
                    <button class="btn btn-secondary" id="swapBtn" title="äº¤æ¢è¯­è¨€">
                        <span>â‡„ äº¤æ¢</span>
                    </button>
                </div>
                <div class="quick-phrases">
                    <span style="color: #666; font-size: 0.9em; width: 100%;">å¿«æ·çŸ­è¯­ï¼š</span>
                    <button class="phrase-btn" data-phrase="ä½ å¥½ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ">ä½ å¥½ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ </button>
                    <button class="phrase-btn" data-phrase="è¿™ä¸ªå¤šå°‘é’±ï¼Ÿ">è¿™ä¸ªå¤šå°‘é’±ï¼Ÿ</button>
                    <button class="phrase-btn" data-phrase="è°¢è°¢ä½ çš„å¸®åŠ©">è°¢è°¢ä½ çš„å¸®åŠ©</button>
                    <button class="phrase-btn" data-phrase="è¯·é—®æ´—æ‰‹é—´åœ¨å“ªé‡Œï¼Ÿ">è¯·é—®æ´—æ‰‹é—´åœ¨å“ªé‡Œï¼Ÿ</button>
                    <button class="phrase-btn" data-phrase="æˆ‘ä¸å¤ªæ˜ç™½ï¼Œèƒ½å†è¯´ä¸€éå—ï¼Ÿ">æˆ‘ä¸å¤ªæ˜ç™½</button>
                </div>
            </div>

            <div class="output-panel">
                <div class="panel-header">
                    <span class="panel-title">ç›®æ ‡è¯­è¨€</span>
                    <select class="language-select" id="targetLang">
                        <option value="en-US">è‹±è¯­</option>
                        <option value="zh-CN">ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰</option>
                        <option value="zh-TW">ä¸­æ–‡ï¼ˆç¹ä½“ï¼‰</option>
                        <option value="ja-JP">æ—¥è¯­</option>
                        <option value="ko-KR">éŸ©è¯­</option>
                        <option value="fr-FR">æ³•è¯­</option>
                        <option value="de-DE">å¾·è¯­</option>
                        <option value="es-ES">è¥¿ç­ç‰™è¯­</option>
                        <option value="ru-RU">ä¿„è¯­</option>
                        <option value="ar-SA">é˜¿æ‹‰ä¼¯è¯­</option>
                        <option value="pt-PT">è‘¡è„ç‰™è¯­</option>
                        <option value="it-IT">æ„å¤§åˆ©è¯­</option>
                        <option value="th-TH">æ³°è¯­</option>
                        <option value="vi-VN">è¶Šå—è¯­</option>
                    </select>
                </div>
                <textarea id="outputText" placeholder="ç¿»è¯‘ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..." readonly></textarea>
                <div class="char-count" id="outputCharCount">0 å­—ç¬¦</div>
                <div class="controls">
                    <button class="btn btn-success" id="speakBtn">
                        <span>ğŸ”Š æœ—è¯»ç¿»è¯‘</span>
                    </button>
                    <button class="btn btn-secondary" id="copyBtn">
                        <span>ğŸ“‹ å¤åˆ¶ç»“æœ</span>
                    </button>
                </div>
                <div class="voice-controls" id="voiceControls" style="margin-top: 12px; display: none;">
                    <div style="display: flex; align-items: center; gap: 12px; font-size: 0.9em; color: #86868b;">
                        <span>ğŸšï¸ è¯­é€Ÿï¼š</span>
                        <input type="range" id="speedControl" min="0.5" max="1.5" step="0.1" value="0.9" 
                               style="flex: 1; height: 4px; border-radius: 2px; outline: none; appearance: none; -webkit-appearance: none; 
                                      background: linear-gradient(to right, #007aff 0%, #007aff 40%, rgba(120,120,128,0.2) 40%, rgba(120,120,128,0.2) 100%);">
                        <span id="speedValue" style="min-width: 35px; font-weight: 600; color: #007aff;">0.9x</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="history-panel" id="historyPanel">
            <div class="panel-title" style="margin-bottom: 15px;">ğŸ“š ç¿»è¯‘å†å²</div>
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentMode = 'auto';
        let translationHistory = [];
        let translationTimer = null;
        let isTranslating = false;

        // DeepSeek API é…ç½®
        const DEEPSEEK_API_KEY = 'sk-5293fc97343945cd92a46a357f307eaa';
        const DEEPSEEK_BASE_URL = 'https://api.deepseek.com/chat/completions';

        // DOM å…ƒç´ 
        const inputText = document.getElementById('inputText');
        const outputText = document.getElementById('outputText');
        const sourceLang = document.getElementById('sourceLang');
        const targetLang = document.getElementById('targetLang');
        const clearBtn = document.getElementById('clearBtn');
        const swapBtn = document.getElementById('swapBtn');
        const speakBtn = document.getElementById('speakBtn');
        const copyBtn = document.getElementById('copyBtn');
        const statusBar = document.getElementById('statusBar');
        const charCount = document.getElementById('charCount');
        const outputCharCount = document.getElementById('outputCharCount');
        const modeBtns = document.querySelectorAll('.mode-btn');
        const phraseBtns = document.querySelectorAll('.phrase-btn');
        const historyList = document.getElementById('historyList');
        const translatingIndicator = document.getElementById('translatingIndicator');
        const voiceControls = document.getElementById('voiceControls');
        const speedControl = document.getElementById('speedControl');
        const speedValue = document.getElementById('speedValue');
        
        // ç”¨æˆ·è‡ªå®šä¹‰è¯­é€Ÿ
        let userSpeechRate = 0.9;

        // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
        // å®‰æ’ç¿»è¯‘ï¼ˆå¸¦é˜²æŠ–ï¼‰
        function scheduleTranslation(delay = 1000) {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (translationTimer) {
                clearTimeout(translationTimer);
            }

            // è®¾ç½®æ–°çš„å®šæ—¶å™¨
            translationTimer = setTimeout(() => {
                const text = inputText.value.trim();
                if (text && !isTranslating) {
                    translate();
                }
            }, delay);
        }

        // æ£€æµ‹æ–‡æœ¬è¯­è¨€
        function detectLanguage(text) {
            // ç®€å•çš„è¯­è¨€æ£€æµ‹é€»è¾‘
            const chinesePattern = /[\u4e00-\u9fa5]/;
            const japanesePattern = /[\u3040-\u309f\u30a0-\u30ff]/;
            const koreanPattern = /[\uac00-\ud7af]/;
            const arabicPattern = /[\u0600-\u06ff]/;
            const thaiPattern = /[\u0e00-\u0e7f]/;
            const cyrillicPattern = /[\u0400-\u04ff]/;
            
            if (chinesePattern.test(text)) {
                return 'zh-CN';
            } else if (japanesePattern.test(text)) {
                return 'ja';
            } else if (koreanPattern.test(text)) {
                return 'ko';
            } else if (arabicPattern.test(text)) {
                return 'ar';
            } else if (thaiPattern.test(text)) {
                return 'th';
            } else if (cyrillicPattern.test(text)) {
                return 'ru';
            } else {
                // é»˜è®¤ä¸ºè‹±æ–‡
                return 'en';
            }
        }

        // ä½¿ç”¨ DeepSeek API è¿›è¡Œç¿»è¯‘
        async function translateWithDeepSeek(text, sourceLangCode, targetLangCode) {
            const sourceLangName = getLanguageName(sourceLangCode);
            const targetLangName = getLanguageName(targetLangCode);
            
            // æ„å»ºç¿»è¯‘æç¤ºè¯
            let systemPrompt = `You are a professional translator. Translate the given text accurately and naturally.`;
            let userPrompt = `Translate the following text from ${sourceLangName} to ${targetLangName}. Only provide the translation, without any explanations or additional text.\n\nText to translate: ${text}`;
            
            // å¦‚æœæ˜¯ä¸­æ–‡è½¬è‹±æ–‡å£è¯­åŒ–æ¨¡å¼
            if (currentMode === 'chinese-to-english' && targetLangCode.startsWith('en')) {
                systemPrompt = `You are a professional translator specializing in colloquial English. Translate Chinese to natural, conversational English.`;
                userPrompt = `Translate the following Chinese text to colloquial, natural English. Use contractions (like I'm, don't, can't) and conversational expressions. Only provide the translation.\n\nText: ${text}`;
            }

            try {
                const response = await fetch(DEEPSEEK_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userPrompt }
                        ],
                        stream: false,
                        temperature: 0.3
                    })
                });

                if (!response.ok) {
                    throw new Error(`DeepSeek API error: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                    return data.choices[0].message.content.trim();
                } else {
                    throw new Error('Invalid response from DeepSeek API');
                }
            } catch (error) {
                console.error('DeepSeek API é”™è¯¯:', error);
                throw error;
            }
        }

        // è·å–è¯­è¨€åç§°
        function getLanguageName(code) {
            const languageNames = {
                'zh-CN': 'Simplified Chinese',
                'zh-TW': 'Traditional Chinese',
                'en-US': 'English',
                'en': 'English',
                'ja-JP': 'Japanese',
                'ja': 'Japanese',
                'ko-KR': 'Korean',
                'ko': 'Korean',
                'fr-FR': 'French',
                'fr': 'French',
                'de-DE': 'German',
                'de': 'German',
                'es-ES': 'Spanish',
                'es': 'Spanish',
                'ru-RU': 'Russian',
                'ru': 'Russian',
                'ar-SA': 'Arabic',
                'ar': 'Arabic',
                'pt-PT': 'Portuguese',
                'pt': 'Portuguese',
                'it-IT': 'Italian',
                'it': 'Italian',
                'th-TH': 'Thai',
                'th': 'Thai',
                'vi-VN': 'Vietnamese',
                'vi': 'Vietnamese'
            };
            return languageNames[code] || code;
        }

        // ç¿»è¯‘åŠŸèƒ½ï¼ˆæ”¹è¿›ç‰ˆ - ä½¿ç”¨ DeepSeek APIï¼‰
        async function translate() {
            const text = inputText.value.trim();
            if (!text) {
                outputText.value = '';
                updateOutputCharCount();
                return;
            }

            // é˜²æ­¢é‡å¤ç¿»è¯‘
            if (isTranslating) {
                return;
            }

            isTranslating = true;
            translatingIndicator.classList.add('active');
            statusBar.classList.add('translating');
            updateStatus('â³ æ­£åœ¨æ™ºèƒ½ç¿»è¯‘...', false);

            try {
                let sourceLangCode = sourceLang.value;
                let targetLangCode = targetLang.value;

                // å¦‚æœæ˜¯è‡ªåŠ¨æ£€æµ‹ï¼Œå…ˆæ£€æµ‹è¯­è¨€
                if (sourceLangCode === 'auto') {
                    sourceLangCode = detectLanguage(text);
                    console.log('æ£€æµ‹åˆ°çš„è¯­è¨€:', sourceLangCode);
                }

                // è½¬æ¢è¯­è¨€ä»£ç ä¸ºæ ‡å‡†æ ¼å¼
                const sourceCode = convertToMyMemoryCode(sourceLangCode);
                const targetCode = convertToMyMemoryCode(targetLangCode);

                // å¦‚æœæºè¯­è¨€å’Œç›®æ ‡è¯­è¨€ç›¸åŒï¼Œä¸ç¿»è¯‘
                if (sourceCode === targetCode) {
                    outputText.value = text;
                    updateOutputCharCount();
                    updateStatus('âœ… æºè¯­è¨€ä¸ç›®æ ‡è¯­è¨€ç›¸åŒ', false);
                    return;
                }

                let translatedText = null;
                
                // ä¼˜å…ˆä½¿ç”¨ DeepSeek API
                try {
                    console.log('ä½¿ç”¨ DeepSeek API ç¿»è¯‘...');
                    translatedText = await translateWithDeepSeek(text, sourceCode, targetCode);
                    console.log('DeepSeek ç¿»è¯‘æˆåŠŸ');
                } catch (deepseekError) {
                    console.log('DeepSeek API å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ...', deepseekError);
                    
                    // å¤‡ç”¨æ–¹æ¡ˆ1: ä½¿ç”¨ MyMemory API
                try {
                    const apiUrl = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceCode}|${targetCode}`;
                    const response = await fetch(apiUrl);
                    const data = await response.json();

                    if (data.responseStatus === 200 && data.responseData && data.responseData.translatedText) {
                        translatedText = data.responseData.translatedText;
                        
                        if (translatedText && translatedText.toLowerCase() !== text.toLowerCase()) {
                            console.log('MyMemory ç¿»è¯‘æˆåŠŸ');
                        } else {
                            throw new Error('ç¿»è¯‘ç»“æœæ— æ•ˆ');
                        }
                    } else {
                        throw new Error('APIè¿”å›é”™è¯¯');
                    }
                } catch (apiError) {
                        console.log('MyMemory API ä¹Ÿå¤±è´¥äº†', apiError);
                        
                        // å¤‡ç”¨æ–¹æ¡ˆ2: ä½¿ç”¨æœ¬åœ°ç¿»è¯‘
                    translatedText = localTranslate(text, targetLangCode) || 
                                   enhancedLocalTranslate(text, sourceCode, targetCode);
                }
                    }

                if (translatedText) {
                    outputText.value = translatedText;
                    updateOutputCharCount();
                    updateStatus('âœ… ç¿»è¯‘å®Œæˆ', false);
                    
                    // æ˜¾ç¤ºè¯­éŸ³æ§åˆ¶é¢æ¿
                    if (voiceControls) {
                        voiceControls.style.display = 'block';
                    }

                    // æ·»åŠ åˆ°å†å²è®°å½•
                    addToHistory(text, translatedText, sourceCode, targetCode);
                } else {
                    throw new Error('æ‰€æœ‰ç¿»è¯‘æ–¹æ³•å‡å¤±è´¥');
                }

            } catch (error) {
                console.error('ç¿»è¯‘é”™è¯¯:', error);
                outputText.value = 'æŠ±æ­‰ï¼Œç¿»è¯‘æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ã€‚è¯·ç¨åé‡è¯•æˆ–æ›´æ¢ç¿»è¯‘å†…å®¹ã€‚';
                updateStatus('ç¿»è¯‘é‡åˆ°é—®é¢˜', false);
                
                if (voiceControls) {
                    voiceControls.style.display = 'none';
                }
            } finally {
                isTranslating = false;
                translatingIndicator.classList.remove('active');
                statusBar.classList.remove('translating');
            }
        }

        // å¢å¼ºçš„æœ¬åœ°ç¿»è¯‘ï¼ˆæ›´å¤šè¯æ±‡ï¼‰
        function enhancedLocalTranslate(text, sourceCode, targetCode) {
            const translations = {
                'zh-CN_en': {
                    'ä½ å¥½': 'Hello',
                    'æ‚¨å¥½': 'Hello',
                    'è°¢è°¢': 'Thank you',
                    'å†è§': 'Goodbye',
                    'æ—©ä¸Šå¥½': 'Good morning',
                    'æ™šä¸Šå¥½': 'Good evening',
                    'æ™šå®‰': 'Good night',
                    'æ˜¯': 'Yes',
                    'ä¸æ˜¯': 'No',
                    'å¯¹ä¸èµ·': 'Sorry',
                    'è¯·': 'Please',
                    'è°¢è°¢ä½ ': 'Thank you',
                    'ä¸å®¢æ°”': 'You\'re welcome',
                    'æˆ‘çˆ±ä½ ': 'I love you',
                    'å¸®åŠ©': 'Help',
                    'æœ‹å‹': 'Friend',
                    'å®¶äºº': 'Family',
                    'å·¥ä½œ': 'Work',
                    'å­¦ä¹ ': 'Study'
                },
                'en_zh-CN': {
                    'hello': 'ä½ å¥½',
                    'hi': 'å—¨',
                    'thank you': 'è°¢è°¢',
                    'thanks': 'è°¢è°¢',
                    'goodbye': 'å†è§',
                    'bye': 'å†è§',
                    'good morning': 'æ—©ä¸Šå¥½',
                    'good evening': 'æ™šä¸Šå¥½',
                    'good night': 'æ™šå®‰',
                    'yes': 'æ˜¯çš„',
                    'no': 'ä¸',
                    'sorry': 'å¯¹ä¸èµ·',
                    'please': 'è¯·',
                    'you\'re welcome': 'ä¸å®¢æ°”',
                    'i love you': 'æˆ‘çˆ±ä½ ',
                    'help': 'å¸®åŠ©',
                    'friend': 'æœ‹å‹',
                    'family': 'å®¶äºº',
                    'work': 'å·¥ä½œ',
                    'study': 'å­¦ä¹ '
                }
            };

            const key = `${sourceCode}_${targetCode}`;
            const dict = translations[key];
            
            if (dict) {
                const lowerText = text.toLowerCase().trim();
                return dict[lowerText] || null;
            }
            
            return null;
        }

        // è½¬æ¢è¯­è¨€ä»£ç 
        function convertToMyMemoryCode(code) {
            const codeMap = {
                'auto': 'auto',
                'zh-CN': 'zh-CN',
                'zh-TW': 'zh-TW',
                'en-US': 'en',
                'ja-JP': 'ja',
                'ko-KR': 'ko',
                'fr-FR': 'fr',
                'de-DE': 'de',
                'es-ES': 'es',
                'ru-RU': 'ru',
                'ar-SA': 'ar',
                'pt-PT': 'pt',
                'it-IT': 'it',
                'th-TH': 'th',
                'vi-VN': 'vi'
            };
            return codeMap[code] || code.split('-')[0];
        }

        // å£è¯­åŒ–å¤„ç†
        function makeColloquial(text) {
            // åŸºæœ¬çš„å£è¯­åŒ–è½¬æ¢
            const colloquialMap = {
                'I am': "I'm",
                'you are': "you're",
                'he is': "he's",
                'she is': "she's",
                'it is': "it's",
                'we are': "we're",
                'they are': "they're",
                'I will': "I'll",
                'you will': "you'll",
                'he will': "he'll",
                'she will': "she'll",
                'we will': "we'll",
                'they will': "they'll",
                'do not': "don't",
                'does not': "doesn't",
                'did not': "didn't",
                'cannot': "can't",
                'could not': "couldn't",
                'would not': "wouldn't",
                'should not': "shouldn't",
                'have not': "haven't",
                'has not': "hasn't",
                'had not': "hadn't",
                'is not': "isn't",
                'are not': "aren't",
                'was not': "wasn't",
                'were not': "weren't",
                'will not': "won't"
            };

            let result = text;
            for (const [formal, colloquial] of Object.entries(colloquialMap)) {
                const regex = new RegExp('\\b' + formal + '\\b', 'gi');
                result = result.replace(regex, colloquial);
            }

            return result;
        }

        // æœ¬åœ°ç®€å•ç¿»è¯‘ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
        function localTranslate(text, targetLangCode) {
            // è¿™æ˜¯ä¸€ä¸ªéå¸¸åŸºç¡€çš„ç¿»è¯‘å­—å…¸ï¼Œä»…ç”¨äºæ¼”ç¤º
            const basicTranslations = {
                'zh-CN': {
                    'en-US': {
                        'ä½ å¥½': 'Hello',
                        'è°¢è°¢': 'Thank you',
                        'å†è§': 'Goodbye',
                        'æ˜¯': 'Yes',
                        'ä¸': 'No'
                    }
                },
                'en-US': {
                    'zh-CN': {
                        'hello': 'ä½ å¥½',
                        'thank you': 'è°¢è°¢',
                        'goodbye': 'å†è§',
                        'yes': 'æ˜¯',
                        'no': 'ä¸'
                    }
                }
            };

            const sourceLangCode = sourceLang.value === 'auto' ? 'zh-CN' : sourceLang.value;
            
            if (basicTranslations[sourceLangCode] && basicTranslations[sourceLangCode][targetLangCode]) {
                const lowerText = text.toLowerCase();
                return basicTranslations[sourceLangCode][targetLangCode][lowerText] || null;
            }

            return null;
        }

        // è¯­éŸ³æœ—è¯»ï¼ˆä¼˜åŒ–ç‰ˆ - æ›´æ¸…æ™°çš„å‘éŸ³ï¼‰
        function speakText() {
            const text = outputText.value.trim();
            if (!text) {
                updateStatus('æ²¡æœ‰å¯æœ—è¯»çš„å†…å®¹', false);
                return;
            }

            if ('speechSynthesis' in window) {
                // åœæ­¢å½“å‰æœ—è¯»
                window.speechSynthesis.cancel();

                // ç­‰å¾…è¯­éŸ³å¼•æ“åŠ è½½
                setTimeout(() => {
                    const voices = window.speechSynthesis.getVoices();
                    const langCode = targetLang.value;
                    
                    // é¢„å¤„ç†æ–‡æœ¬ - ä¼˜åŒ–æ–­å¥
                    const processedText = preprocessTextForSpeech(text, langCode);
                    
                    // é€‰æ‹©æœ€ä½³è¯­éŸ³å¼•æ“
                    const bestVoice = selectBestVoice(voices, langCode);
                    
                    const utterance = new SpeechSynthesisUtterance(processedText);
                    utterance.lang = langCode;
                    
                    // è®¾ç½®æœ€ä½³è¯­éŸ³
                    if (bestVoice) {
                        utterance.voice = bestVoice;
                    }
                    
                    // ä¼˜åŒ–è¯­éŸ³å‚æ•°ï¼ˆä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„è¯­é€Ÿï¼‰
                    const voiceSettings = getOptimalVoiceSettings(langCode);
                    utterance.rate = userSpeechRate; // ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰è¯­é€Ÿ
                    utterance.pitch = voiceSettings.pitch;
                    utterance.volume = voiceSettings.volume;

                    utterance.onstart = () => {
                        speakBtn.disabled = true;
                        speakBtn.innerHTML = '<span>â¸ åœæ­¢æœ—è¯»</span>';
                        speakBtn.classList.add('btn-danger');
                        speakBtn.classList.remove('btn-success');
                        updateStatus('ğŸ”Š æ­£åœ¨æœ—è¯»...', false);
                    };

                    utterance.onend = () => {
                        speakBtn.disabled = false;
                        speakBtn.innerHTML = '<span>ğŸ”Š æœ—è¯»ç¿»è¯‘</span>';
                        speakBtn.classList.add('btn-success');
                        speakBtn.classList.remove('btn-danger');
                        updateStatus('æœ—è¯»å®Œæˆ', false);
                    };

                    utterance.onerror = (event) => {
                        console.error('æœ—è¯»é”™è¯¯:', event);
                        speakBtn.disabled = false;
                        speakBtn.innerHTML = '<span>ğŸ”Š æœ—è¯»ç¿»è¯‘</span>';
                        speakBtn.classList.add('btn-success');
                        speakBtn.classList.remove('btn-danger');
                        updateStatus('æœ—è¯»å®Œæˆ', false);
                    };

                    // ç‚¹å‡»æŒ‰é’®æ—¶å¯ä»¥åœæ­¢æœ—è¯»
                    speakBtn.onclick = () => {
                        if (window.speechSynthesis.speaking) {
                            window.speechSynthesis.cancel();
                            speakBtn.disabled = false;
                            speakBtn.innerHTML = '<span>ğŸ”Š æœ—è¯»ç¿»è¯‘</span>';
                            speakBtn.classList.add('btn-success');
                            speakBtn.classList.remove('btn-danger');
                            updateStatus('å·²åœæ­¢æœ—è¯»', false);
                        } else {
                            speakText();
                        }
                    };

                    window.speechSynthesis.speak(utterance);
                }, 100);
            } else {
                updateStatus('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æ’­æ”¾', false);
            }
        }

        // é¢„å¤„ç†æ–‡æœ¬ä»¥ä¼˜åŒ–è¯­éŸ³åˆæˆ
        function preprocessTextForSpeech(text, langCode) {
            let processed = text;
            
            // æ ¹æ®è¯­è¨€è¿›è¡Œä¸åŒçš„å¤„ç†
            if (langCode.startsWith('zh')) {
                // ä¸­æ–‡ï¼šä¼˜åŒ–æ–­å¥
                processed = processed.replace(/([ã€‚ï¼ï¼Ÿï¼›])/g, '$1 '); // å¥å·ååŠ åœé¡¿
                processed = processed.replace(/([ï¼Œã€])/g, '$1'); // é€—å·ä¿æŒ
                processed = processed.replace(/\s+/g, ' '); // æ¸…ç†å¤šä½™ç©ºæ ¼
            } else if (langCode.startsWith('en')) {
                // è‹±æ–‡ï¼šä¼˜åŒ–æ–­å¥å’Œç¼©å†™
                processed = processed.replace(/([.!?])\s*/g, '$1 '); // å¥æœ«åŠ åœé¡¿
                processed = processed.replace(/([,;:])\s*/g, '$1 '); // æ ‡ç‚¹ååŠ ç©ºæ ¼
                processed = processed.replace(/\s+/g, ' '); // æ¸…ç†å¤šä½™ç©ºæ ¼
                
                // å¤„ç†å¸¸è§ç¼©å†™ï¼Œè®©å‘éŸ³æ›´è‡ªç„¶
                processed = processed.replace(/\bi\.e\./gi, 'that is');
                processed = processed.replace(/\be\.g\./gi, 'for example');
                processed = processed.replace(/\betc\./gi, 'et cetera');
            } else if (langCode.startsWith('ja')) {
                // æ—¥æ–‡ï¼šä¼˜åŒ–æ–­å¥
                processed = processed.replace(/([ã€‚ï¼ï¼Ÿ])/g, '$1 ');
                processed = processed.replace(/([ã€ï¼Œ])/g, '$1');
            } else if (langCode.startsWith('ko')) {
                // éŸ©æ–‡ï¼šä¼˜åŒ–æ–­å¥
                processed = processed.replace(/([.!?ã€‚ï¼ï¼Ÿ])/g, '$1 ');
            }
            
            return processed.trim();
        }

        // é€‰æ‹©æœ€ä½³è¯­éŸ³å¼•æ“
        function selectBestVoice(voices, langCode) {
            if (!voices || voices.length === 0) return null;
            
            // å°†è¯­è¨€ä»£ç è½¬æ¢ä¸ºç®€çŸ­æ ¼å¼
            const shortLang = langCode.split('-')[0];
            
            // å®šä¹‰ä¼˜å…ˆçº§ï¼ˆé«˜è´¨é‡è¯­éŸ³ä¼˜å…ˆï¼‰
            const voicePriority = {
                'zh': ['Google æ™®é€šè¯', 'Microsoft Huihui', 'Ting-Ting', 'Sin-ji', 'Google åœ‹èª', 'Microsoft Zhiwei'],
                'en': ['Google US English', 'Google UK English', 'Samantha', 'Microsoft Zira', 'Microsoft David', 'Alex'],
                'ja': ['Google æ—¥æœ¬èª', 'Kyoko', 'Microsoft Haruka', 'Otoya'],
                'ko': ['Google í•œêµ­ì˜', 'Yuna', 'Microsoft Heami'],
                'fr': ['Google franÃ§ais', 'Thomas', 'Microsoft Hortense'],
                'de': ['Google Deutsch', 'Anna', 'Microsoft Hedda'],
                'es': ['Google espaÃ±ol', 'Monica', 'Microsoft Helena'],
                'ru': ['Google Ñ€ÑƒÑÑĞºĞ¸Ğ¹', 'Milena', 'Microsoft Irina'],
                'ar': ['Google Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', 'Maged', 'Microsoft Naayf'],
                'it': ['Google italiano', 'Alice', 'Microsoft Elsa'],
                'pt': ['Google portuguÃªs', 'Luciana', 'Microsoft Heloisa'],
                'th': ['Google à¹„à¸—à¸¢', 'Microsoft Achara'],
                'vi': ['Google Tiáº¿ng Viá»‡t']
            };
            
            const preferredVoices = voicePriority[shortLang] || [];
            
            // é¦–å…ˆå°è¯•åŒ¹é…é«˜è´¨é‡è¯­éŸ³
            for (const preferred of preferredVoices) {
                const voice = voices.find(v => v.name.includes(preferred));
                if (voice) return voice;
            }
            
            // ç„¶åå°è¯•æœ¬åœ°è¯­éŸ³
            const localVoices = voices.filter(v => 
                v.lang.startsWith(shortLang) && v.localService
            );
            if (localVoices.length > 0) {
                // ä¼˜å…ˆé€‰æ‹©åŒ…å«"Premium"æˆ–"Enhanced"çš„è¯­éŸ³
                const premiumVoice = localVoices.find(v => 
                    v.name.includes('Premium') || 
                    v.name.includes('Enhanced') ||
                    v.name.includes('Natural')
                );
                if (premiumVoice) return premiumVoice;
                return localVoices[0];
            }
            
            // æœ€åå°è¯•ä»»ä½•åŒ¹é…è¯­è¨€çš„è¯­éŸ³
            const matchingVoices = voices.filter(v => v.lang.startsWith(shortLang));
            if (matchingVoices.length > 0) {
                // ä¼˜å…ˆGoogleè¯­éŸ³
                const googleVoice = matchingVoices.find(v => v.name.includes('Google'));
                if (googleVoice) return googleVoice;
                return matchingVoices[0];
            }
            
            return null;
        }

        // è·å–æœ€ä½³è¯­éŸ³å‚æ•°è®¾ç½®
        function getOptimalVoiceSettings(langCode) {
            const shortLang = langCode.split('-')[0];
            
            // ä¸åŒè¯­è¨€çš„æœ€ä½³å‚æ•°ï¼ˆå‚è€ƒGoogleç¿»è¯‘å’Œç™¾åº¦ç¿»è¯‘ï¼‰
            const settings = {
                'zh': { rate: 0.85, pitch: 1.0, volume: 1.0 },    // ä¸­æ–‡ï¼šç¨æ…¢ï¼Œæ¸…æ™°
                'en': { rate: 0.9, pitch: 1.0, volume: 1.0 },     // è‹±æ–‡ï¼šè‡ªç„¶è¯­é€Ÿ
                'ja': { rate: 0.85, pitch: 1.05, volume: 1.0 },   // æ—¥æ–‡ï¼šç¨æ…¢ï¼ŒéŸ³è°ƒç•¥é«˜
                'ko': { rate: 0.88, pitch: 1.0, volume: 1.0 },    // éŸ©æ–‡ï¼šé€‚ä¸­
                'fr': { rate: 0.9, pitch: 1.0, volume: 1.0 },     // æ³•æ–‡ï¼šæµç•…
                'de': { rate: 0.88, pitch: 0.98, volume: 1.0 },   // å¾·æ–‡ï¼šç¨æ…¢ï¼ŒéŸ³è°ƒç•¥ä½
                'es': { rate: 0.92, pitch: 1.02, volume: 1.0 },   // è¥¿ç­ç‰™æ–‡ï¼šç•¥å¿«
                'ru': { rate: 0.85, pitch: 0.98, volume: 1.0 },   // ä¿„æ–‡ï¼šç¨æ…¢
                'ar': { rate: 0.85, pitch: 1.0, volume: 1.0 },    // é˜¿æ‹‰ä¼¯æ–‡ï¼šæ¸…æ™°
                'it': { rate: 0.9, pitch: 1.0, volume: 1.0 },     // æ„å¤§åˆ©æ–‡ï¼šè‡ªç„¶
                'pt': { rate: 0.88, pitch: 1.0, volume: 1.0 },    // è‘¡è„ç‰™æ–‡ï¼šé€‚ä¸­
                'th': { rate: 0.85, pitch: 1.0, volume: 1.0 },    // æ³°æ–‡ï¼šæ¸…æ™°
                'vi': { rate: 0.88, pitch: 1.0, volume: 1.0 }     // è¶Šå—æ–‡ï¼šé€‚ä¸­
            };
            
            return settings[shortLang] || { rate: 0.9, pitch: 1.0, volume: 1.0 };
        }

        // å¤åˆ¶æ–‡æœ¬
        function copyToClipboard() {
            const text = outputText.value.trim();
            if (!text) {
                updateStatus('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹', false);
                return;
            }

            navigator.clipboard.writeText(text).then(() => {
                updateStatus('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', false);
                
                // æ›´æ–°æŒ‰é’®æ–‡å­—
                copyBtn.innerHTML = '<span>âœ… å·²å¤åˆ¶</span>';
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                showSuccessNotification('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                
                setTimeout(() => {
                    copyBtn.innerHTML = '<span>ğŸ“‹ å¤åˆ¶ç»“æœ</span>';
                }, 2000);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                // é™çº§æ–¹æ¡ˆ
                try {
                    outputText.select();
                    document.execCommand('copy');
                    updateStatus('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', false);
                    copyBtn.innerHTML = '<span>âœ… å·²å¤åˆ¶</span>';
                    showSuccessNotification('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    setTimeout(() => {
                        copyBtn.innerHTML = '<span>ğŸ“‹ å¤åˆ¶ç»“æœ</span>';
                    }, 2000);
                } catch (e) {
                    updateStatus('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', false);
                }
            });
        }

        // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
        function showSuccessNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                color: #1d1d1f;
                padding: 14px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                font-weight: 500;
                font-size: 0.95em;
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 8px;
                opacity: 0;
                transform: translateY(-10px);
                transition: all 0.3s ease;
            `;
            notification.innerHTML = `<span style="color: #34c759; font-size: 1.2em;">âœ“</span> ${message}`;
            
            document.body.appendChild(notification);
            
            // è§¦å‘åŠ¨ç”»
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateY(0)';
            }, 10);
            
            // ç§»é™¤é€šçŸ¥
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-10px)';
                setTimeout(() => notification.remove(), 300);
            }, 2500);
        }

        // æ¸…ç©ºå†…å®¹
        function clearAll() {
            // åœæ­¢è¯­éŸ³æœ—è¯»
            if (window.speechSynthesis && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
            
            // æ¸…é™¤å®šæ—¶å™¨
            if (translationTimer) {
                clearTimeout(translationTimer);
            }
            
            inputText.value = '';
            outputText.value = '';
            updateCharCount();
            updateOutputCharCount();
            translatingIndicator.classList.remove('active');
            
            // éšè—è¯­éŸ³æ§åˆ¶é¢æ¿
            if (voiceControls) {
                voiceControls.style.display = 'none';
            }
            
            // é‡ç½®è¯­éŸ³æŒ‰é’®çŠ¶æ€
            speakBtn.disabled = false;
            speakBtn.innerHTML = '<span>ğŸ”Š æœ—è¯»ç¿»è¯‘</span>';
            speakBtn.classList.add('btn-success');
            speakBtn.classList.remove('btn-danger');
            
            updateStatus('å‡†å¤‡å°±ç»ª', false);
        }

        // äº¤æ¢è¯­è¨€
        function swapLanguages() {
            if (sourceLang.value === 'auto') {
                updateStatus('è‡ªåŠ¨æ£€æµ‹æ¨¡å¼æ— æ³•äº¤æ¢è¯­è¨€', true);
                return;
            }

            const temp = sourceLang.value;
            sourceLang.value = targetLang.value;
            targetLang.value = temp;

            const tempText = inputText.value;
            inputText.value = outputText.value;
            outputText.value = tempText;

            updateCharCount();
            updateOutputCharCount();
            updateStatus('è¯­è¨€å·²äº¤æ¢', false);
        }

        // æ›´æ–°å­—ç¬¦è®¡æ•°
        function updateCharCount() {
            const count = inputText.value.length;
            charCount.textContent = `${count} / 5000 å­—ç¬¦`;
            if (count > 5000) {
                charCount.style.color = '#c62828';
            } else {
                charCount.style.color = '#666';
            }
        }

        function updateOutputCharCount() {
            const count = outputText.value.length;
            outputCharCount.textContent = `${count} å­—ç¬¦`;
        }

        // æ›´æ–°çŠ¶æ€æ 
        function updateStatus(message, isError = false) {
            statusBar.textContent = message;
            if (isError) {
                statusBar.style.background = '#ffebee';
                statusBar.style.color = '#c62828';
            } else {
                statusBar.style.background = '#e3f2fd';
                statusBar.style.color = '#1976d2';
            }
            statusBar.classList.remove('recording');
        }

        // æ·»åŠ åˆ°å†å²è®°å½•
        function addToHistory(source, translation, sourceLang, targetLang) {
            const historyItem = {
                source,
                translation,
                sourceLang,
                targetLang,
                timestamp: new Date().toLocaleString('zh-CN')
            };

            translationHistory.unshift(historyItem);
            if (translationHistory.length > 10) {
                translationHistory.pop();
            }

            renderHistory();
        }

        // æ¸²æŸ“å†å²è®°å½•
        function renderHistory() {
            if (translationHistory.length === 0) {
                historyList.innerHTML = '<div style="text-align: center; color: #999;">æš‚æ— ç¿»è¯‘å†å²</div>';
                return;
            }

            historyList.innerHTML = translationHistory.map((item, index) => `
                <div class="history-item" onclick="loadHistoryItem(${index})">
                    <div class="history-text">${item.source}</div>
                    <div class="history-translation">â†’ ${item.translation}</div>
                    <div style="font-size: 0.8em; color: #999; margin-top: 5px;">${item.timestamp}</div>
                </div>
            `).join('');
        }

        // åŠ è½½å†å²è®°å½•é¡¹
        function loadHistoryItem(index) {
            const item = translationHistory[index];
            inputText.value = item.source;
            outputText.value = item.translation;
            updateCharCount();
            updateOutputCharCount();
            updateStatus('å·²åŠ è½½å†å²è®°å½•', false);
        }

        // æ¨¡å¼åˆ‡æ¢
        modeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                modeBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = btn.dataset.mode;

                switch(currentMode) {
                    case 'auto':
                        sourceLang.value = 'auto';
                        targetLang.value = 'en-US';
                        updateStatus('è‡ªåŠ¨æ£€æµ‹è¯­è¨€æ¨¡å¼', false);
                        break;
                    case 'chinese-to-english':
                        sourceLang.value = 'zh-CN';
                        targetLang.value = 'en-US';
                        updateStatus('ä¸­æ–‡è½¬è‹±æ–‡å£è¯­æ¨¡å¼', false);
                        break;
                }

                // å¦‚æœæœ‰å†…å®¹ï¼Œé‡æ–°ç¿»è¯‘
                if (inputText.value.trim()) {
                    scheduleTranslation(500);
                }
            });
        });

        // å¿«æ·çŸ­è¯­
        phraseBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                inputText.value = btn.dataset.phrase;
                updateCharCount();
                scheduleTranslation(300); // å¿«æ·çŸ­è¯­å¿«é€Ÿç¿»è¯‘
            });
        });

        // äº‹ä»¶ç›‘å¬å™¨
        clearBtn.addEventListener('click', clearAll);
        swapBtn.addEventListener('click', swapLanguages);
        copyBtn.addEventListener('click', copyToClipboard);
        
        // è¯­éŸ³æŒ‰é’®åˆå§‹ç»‘å®š
        speakBtn.addEventListener('click', speakText);
        
        // è¯­é€Ÿæ§åˆ¶
        if (speedControl) {
            speedControl.addEventListener('input', (e) => {
                userSpeechRate = parseFloat(e.target.value);
                speedValue.textContent = userSpeechRate.toFixed(1) + 'x';
                
                // æ›´æ–°æ»‘å—è¿›åº¦æ¡èƒŒæ™¯
                const percentage = ((userSpeechRate - 0.5) / (1.5 - 0.5)) * 100;
                e.target.style.background = `linear-gradient(to right, #007aff 0%, #007aff ${percentage}%, rgba(120,120,128,0.2) ${percentage}%, rgba(120,120,128,0.2) 100%)`;
            });
            
            // åˆå§‹åŒ–æ»‘å—èƒŒæ™¯
            const initialPercentage = ((userSpeechRate - 0.5) / (1.5 - 0.5)) * 100;
            speedControl.style.background = `linear-gradient(to right, #007aff 0%, #007aff ${initialPercentage}%, rgba(120,120,128,0.2) ${initialPercentage}%, rgba(120,120,128,0.2) 100%)`;
        }

        // è¾“å…¥æ—¶è‡ªåŠ¨ç¿»è¯‘ï¼ˆå¸¦é˜²æŠ–ï¼‰
        inputText.addEventListener('input', () => {
            updateCharCount();
            scheduleTranslation(1500); // åœæ­¢è¾“å…¥1.5ç§’åè‡ªåŠ¨ç¿»è¯‘
        });

        // è¯­è¨€åˆ‡æ¢æ—¶è‡ªåŠ¨é‡æ–°ç¿»è¯‘
        sourceLang.addEventListener('change', () => {
            if (inputText.value.trim()) {
                scheduleTranslation(500);
            }
        });

        targetLang.addEventListener('change', () => {
            if (inputText.value.trim()) {
                scheduleTranslation(500);
            }
        });

        // åˆå§‹åŒ–
        updateCharCount();
        updateOutputCharCount();
        renderHistory();

        // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒå¹¶åˆå§‹åŒ–è¯­éŸ³å¼•æ“
        window.addEventListener('load', () => {
            if (!('speechSynthesis' in window)) {
                speakBtn.disabled = true;
                speakBtn.title = 'å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æ’­æ”¾';
            } else {
                // é¢„åŠ è½½è¯­éŸ³å¼•æ“åˆ—è¡¨
                window.speechSynthesis.getVoices();
                
                // ç›‘å¬è¯­éŸ³åˆ—è¡¨å˜åŒ–ï¼ˆæŸäº›æµè§ˆå™¨éœ€è¦å¼‚æ­¥åŠ è½½ï¼‰
                if (window.speechSynthesis.onvoiceschanged !== undefined) {
                    window.speechSynthesis.onvoiceschanged = () => {
                        const voices = window.speechSynthesis.getVoices();
                        console.log(`å·²åŠ è½½ ${voices.length} ä¸ªè¯­éŸ³å¼•æ“`);
                    };
                }
            }
        });
    </script>
</body>
</html>
